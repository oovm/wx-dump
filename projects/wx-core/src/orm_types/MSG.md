## 聊天记录 (MSG.db)

内部主要的两个表是 `MSG` 和 `Name2ID`, 以及 `MicroMsg`

### Name2ID

- `Name2ID` 这张表只有一列，内容格式是微信号(`wxid_<ID>`)或群聊(`<ID>@chatroom`)
- 查询 `left join Name2ID on n.rowid = MSG.TalkerId` 后发现 `UsrName` 总是和 `StrTalker` 相同

### MSG

- localId: 消息的本地自增 ID, 主键, 无用
- MsgSvrID: 服务器端存储的消息 ID, 看起来完全随机, 无用
- TalkerId: `Name2ID` 表中对应的字段, 暂未发现 `StrTalker != Name2ID[TalkerId]` 的情况
- Type: 消息分类，具体对照见表 1
- SubType: 消息类型子分类，具体对照见表 1
- IsSender: 是否是自己发出的消息，也就是标记消息展示在对话页左边还是右边，取值0或1
- CreateTime: 消息创建时间的秒级时间戳。此处需要进一步实验来确认该时间具体标记的是哪个时间节点，个人猜测的规则如下: 
    - 从这台电脑上发出的消息: 标记代表的是每个消息点下发送按钮的那一刻
    - 从其它设备上发出的/收到的来自其它用户的消息: 标记的是本地从服务器接收到这一消息的时间
- Sequence: 由`CreateTime` 末尾接上三位数字组成的，通常情况下为 000
  - 如果在出现多条 `CreateTime` 相同的消息则最后三位依次递增。
- StatusEx: 未知
- FlagEx: 未知
- Status: 未知
- MsgServerSeq: 未知
- MsgSequence: 未知
- StrTalker: 消息发送者的微信号。特别说明，从这里来看的话，上面的 `TalkerId`
  字段大概率是指的消息所在的房间ID，而非发送者ID，当然也可能和 `TalkerId` 属于重复内容，这一点待确认。
- StrContent: 字符串格式的数据。特别说明的是，除了文本类型的消息外，别的大多类型这一字段都会是一段 XML
  数据标记一些相关信息。通过解析xml可以得到更多的信息，例如图片的宽高、语音的时长等等。
- DisplayContent: 对于拍一拍，保存拍者和被拍者账号信息
- Reserved0: 未知
- Reserved1: 未知
- Reserved2: 未知, 目前恒为空
- Reserved3: 未知, 目前恒为空
- Reserved4: 未知, 目前恒为空
- Reserved5: 未知, 目前恒为空
- Reserved6: 未知, 目前恒为空
- CompressContent: 字面意思是压缩的数据，实际上也就是微信任性不想存在 StrContent
  里的数据在这里（例如带有引用的文本消息等；采用lz4压缩算法压缩）
- BytesExtra: 额外的二进制格式数据
- BytesTrans: 未知, 目前恒为空

表1: MSG.Type字段数值与含义对照表（可能可以扩展到其它数据库中同样标记消息类型这一信息的字段）

| 分类`Type` | 子分类`SubType` | 对应类型                                                        |
|----------|--------------|-------------------------------------------------------------|
| 1        | 0            | 文本                                                          |
| 3        | 0            | 图片                                                          |
| 34       | 0            | 语音                                                          |
| 43       | 0            | 视频                                                          |
| 47       | 0            | 动画表情（第三方开发的表情包）                                             |
| 49       | 1            | 类似文字消息而不一样的消息，目前只见到一个阿里云盘的邀请注册是这样的。估计和57子类的情况一样             |
| 49       | 5            | 卡片式链接，CompressContent 中有标题、简介等，BytesExtra 中有本地缓存的封面路径       |
| 49       | 6            | 文件，CompressContent 中有文件名和下载链接（但不会读），BytesExtra 中有本地保存的路径    |
| 49       | 8            | 用户上传的 GIF 表情，CompressContent 中有CDN链接，不过似乎不能直接访问下载           |
| 49       | 19           | 合并转发的聊天记录，CompressContent 中有详细聊天记录，BytesExtra 中有图片视频等的缓存    |
| 49       | 33/36        | 分享的小程序，CompressContent 中有卡片信息，BytesExtra 中有封面缓存位置           |
| 49       | 57           | 带有引用的文本消息（这种类型下 StrContent 为空，发送和引用的内容均在 CompressContent 中） |
| 49       | 63           | 视频号直播或直播回放等                                                 |
| 49       | 87           | 群公告                                                         |
| 49       | 88           | 视频号直播或直播回放等                                                 |
| 49       | 2000         | 转账消息（包括发出、接收、主动退还）                                          |
| 49       | 2003         | 赠送红包封面                                                      |
| 10000    | 0            | 系统通知（居中出现的那种灰色文字）                                           |
| 10000    | 4            | 拍一拍                                                         |
| 10000    | 8000         | 系统通知（特别包含你邀请别人加入群聊）                                         |